<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO Dashboard - Realtime Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para ocultar el scrollbar pero mantener la funcionalidad */
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-900 text-white h-screen flex flex-col">

    <header class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 shadow-xl">
        <h1 class="text-xl font-bold text-emerald-400 flex items-center gap-2">
            <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
            </span>
            Panel de SupervisiÃ³n CEO
        </h1>
        <div id="status" class="text-xs bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/30">
            Sistema en Tiempo Real
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-1/4 border-r border-slate-700 bg-slate-800 p-4 overflow-y-auto">
            <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-400 mb-4 px-2">Conversaciones Activas</h2>
            <div id="lista-usuarios" class="space-y-2">
                </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-900 relative">
            <div id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-4">
                <div id="placeholder-text" class="text-center text-slate-500 mt-20 flex flex-col items-center">
                    <svg class="w-12 h-12 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path></svg>
                    Selecciona un usuario a la izquierda para ver el chat
                </div>
            </div>

            <div class="p-4 border-t border-slate-700 bg-slate-800 flex justify-end items-center gap-4">
                <span id="label-usuario" class="text-sm text-slate-400"></span>
                <button onclick="detenerSeguimiento()" id="btn-stop" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full transition-all shadow-lg active:scale-95">
                    ðŸ”´ Detener SupervisiÃ³n
                </button>
            </div>
        </main>
    </div>

    <script>
    const SB_URL = "https://oqmedttkbhbqbhzkpykx.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xbWVkdHRrYmhicWJoemtweWt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyNDc1MDUsImV4cCI6MjA2NTgyMzUwNX0.vS7G6cxQkQEkhSuUjJEfzc_1R2omWZVnfjRVHEcRpZU";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let usuarioSeleccionado = null;

    async function cargarFiltros() {
        const { data, error } = await _supabase.from('filtro_telegram_ceo').select('*');
        if (error) return;
        const lista = document.getElementById('lista-usuarios');
        lista.innerHTML = '';
        if (data.length === 0) {
            lista.innerHTML = '<p class="text-xs text-slate-500 px-2 italic">No hay monitoreos activos.</p>';
            return;
        }
        data.forEach(user => {
            const isActive = usuarioSeleccionado === user.user_id;
            lista.innerHTML += `
                <button onclick="seleccionarUsuario('${user.user_id}')" 
                    class="w-full text-left p-3 rounded-lg transition-all border ${isActive ? 'bg-emerald-600/20 border-emerald-500 text-white' : 'bg-slate-700 border-transparent hover:bg-slate-600 text-slate-300'}">
                    <div class="font-mono text-sm">ðŸ‘¤ ${user.user_id}</div>
                </button>`;
        });
    }

    async function seleccionarUsuario(id) {
        usuarioSeleccionado = id;
        document.getElementById('btn-stop').classList.remove('hidden');
        document.getElementById('placeholder-text').classList.add('hidden');
        document.getElementById('label-usuario').innerText = `Vigilando: ${id}`;
        cargarFiltros();

        const { data } = await _supabase.from('mensajes_monitoreo').select('*').eq('user_id', id).order('created_at', { ascending: true });
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        data.forEach(msg => renderizarMensaje(msg));
    }

    function renderizarMensaje(msg) {
        const container = document.getElementById('chat-container');
        const isBot = msg.remitente.toLowerCase().includes('agente');
        container.innerHTML += `
            <div class="flex ${isBot ? 'justify-start' : 'justify-end'} animate-in fade-in slide-in-from-bottom-2">
                <div class="max-w-[80%] p-3 rounded-2xl shadow-md ${isBot ? 'bg-slate-800 text-slate-100' : 'bg-emerald-600 text-white'}">
                    <div class="text-[9px] font-bold opacity-60 mb-1 uppercase">${msg.remitente}</div>
                    <div class="text-sm">${msg.texto}</div>
                </div>
            </div>`;
        container.scrollTop = container.scrollHeight;
    }

    // --- EL MOTOR DE TIEMPO REAL (CORREGIDO) ---
    _supabase
        .channel('dashboard-master')
        // 1. Escuchar NUEVOS MENSAJES para pintar el chat en vivo
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mensajes_monitoreo' }, payload => {
            if (usuarioSeleccionado && payload.new.user_id === usuarioSeleccionado) {
                renderizarMensaje(payload.new);
            }
        })
        // 2. Escuchar ALERTAS DE SESIÃ“N para refrescar la lista lateral
        .on('postgres_changes', { event: '*', schema: 'public', table: 'rastreo_sesiones' }, () => {
            console.log("Nueva actividad detectada...");
            cargarFiltros();
        })
        // 3. Escuchar CAMBIOS EN FILTROS (por si el CEO aÃ±ade a alguien desde n8n)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'filtro_telegram_ceo' }, () => {
            cargarFiltros();
        })
        .subscribe();

    async function detenerSeguimiento() {
        if (!usuarioSeleccionado) return;
        await _supabase.from('filtro_telegram_ceo').delete().eq('user_id', usuarioSeleccionado);
        location.reload();
    }

    cargarFiltros();
</script>
</body>
</html>
